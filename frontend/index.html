<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body class="bg-gray-100">
  <div class="max-w-3xl mx-auto p-4 h-screen flex flex-col">
    <h1 class="text-3xl font-bold text-center mb-4">AI Chat</h1>
    <div id="chat" class="flex-1 overflow-y-auto space-y-4 mb-4 p-2 bg-white rounded shadow"></div>
    <div class="flex">
      <input id="prompt" class="flex-1 border rounded-l px-3 py-2" placeholder="Type your message..." />
      <button id="send" class="bg-blue-500 text-white px-4 py-2 rounded-r">Send</button>
    </div>
  </div>
  <script>
    const ws = new WebSocket(`ws://${location.host}/ws`);
    let currentAnswerDiv = null;
    let currentThinkPre = null;
    let answerBuffer = '';
    let thinkingBuffer = '';

    ws.onmessage = (event) => {
      const msg = JSON.parse(event.data);
      if (msg.type === 'answer') {
        answerBuffer += msg.data;
        if (currentAnswerDiv) {
          currentAnswerDiv.innerHTML = marked.parse(answerBuffer);
        }
      } else if (msg.type === 'thought') {
        thinkingBuffer += msg.data;
        if (currentThinkPre) {
          currentThinkPre.textContent = thinkingBuffer;
          const detail = currentThinkPre.parentElement.parentElement;
          detail.classList.remove('hidden');
        }
      } else if (msg.type === 'done') {
        currentAnswerDiv = null;
        currentThinkPre = null;
        answerBuffer = '';
        thinkingBuffer = '';
      }
    };

    document.getElementById('send').onclick = () => {
      const promptInput = document.getElementById('prompt');
      const text = promptInput.value.trim();
      if (!text) return;

      const chat = document.getElementById('chat');

      const userDiv = document.createElement('div');
      userDiv.className = 'text-right';
      userDiv.innerHTML = `<div class="inline-block bg-blue-100 rounded p-2">${marked.parse(text)}</div>`;
      chat.appendChild(userDiv);

      const assistantDiv = document.createElement('div');
      assistantDiv.className = 'text-left';
      assistantDiv.innerHTML = `
        <div class="inline-block bg-gray-100 rounded p-2 w-full">
          <details class="hidden mb-2">
            <summary class="cursor-pointer text-sm text-gray-500">Model thinking...</summary>
            <pre class="text-xs text-gray-600 whitespace-pre-wrap"></pre>
          </details>
          <div class="answer"></div>
        </div>`;
      chat.appendChild(assistantDiv);
      chat.scrollTop = chat.scrollHeight;

      currentThinkPre = assistantDiv.querySelector('pre');
      currentAnswerDiv = assistantDiv.querySelector('div.answer');
      answerBuffer = '';
      thinkingBuffer = '';

      ws.send(JSON.stringify({ prompt: text }));
      promptInput.value = '';
    };
  </script>
</body>
</html>
